# Development-only compose stack â€” mock GPIO, fake sensor data.
# Usage: docker compose up --build

services:
  mqtt:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
    volumes:
      - ./docker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  hub:
    build:
      context: .
      dockerfile: Dockerfile
      target: hub
    ports:
      - "8080:8080"
    environment:
      MQTT_HOST: mqtt
      MQTT_PORT: "1883"
      RELAY_ACTIVE_LOW: "true"
      WEB_PORT: "8080"
      WEB_BIND: "0.0.0.0"
      DB_URL: "sqlite:/data/irrigation.db?mode=rwc"
      CONFIG_PATH: /config.toml
    volumes:
      - hub-data:/data
      - ./config.toml:/config.toml:ro
    depends_on:
      - mqtt

  node-a:
    build:
      context: .
      dockerfile: Dockerfile
      target: node
    environment:
      MQTT_HOST: mqtt
      MQTT_PORT: "1883"
      NODE_ID: node-a
      SAMPLE_EVERY_S: "5"
      SIM_SCENARIO: drying
      SIM_ZONE_ID: front-lawn
    depends_on:
      - mqtt

  node-b:
    build:
      context: .
      dockerfile: Dockerfile
      target: node
    environment:
      MQTT_HOST: mqtt
      MQTT_PORT: "1883"
      NODE_ID: node-b
      SAMPLE_EVERY_S: "5"
      SIM_SCENARIO: drying
      SIM_ZONE_ID: back-garden
    depends_on:
      - mqtt

volumes:
  hub-data:
